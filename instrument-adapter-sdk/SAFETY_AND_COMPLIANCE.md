# SAFETY & COMPLIANCE â€” Instrument Adapter SDK

**Version**: 1.0.0  
**Date**: December 10, 2025  
**Classification**: Internal Technical Standard  
**Applies To**: All instrument adapter implementations using NewGen Studio SDK

---

## Table of Contents

1. [Human-in-the-Loop (HIL) Requirement](#1-human-in-the-loop-hil-requirement)
2. [Audit & Provenance](#2-audit--provenance)
3. [Network & Security](#3-network--security)
4. [Validation & Qualification](#4-validation--qualification)
5. [Implementation Checklist](#5-implementation-checklist)
6. [Compliance Frameworks](#6-compliance-frameworks)
7. [Appendices](#7-appendices)

---

## 1. Human-in-the-Loop (HIL) Requirement

### 1.1 Operator Signature Mandate

**Requirement**: `sendCommand()` MUST be invoked with a valid `operatorSignature` containing:
- `operatorId` (alphanumeric, format: `OP-YYYY-NNNN`)
- `signature` (Base64-encoded digital signature, minimum 100 characters)
- `timestamp` (ISO 8601, must be recent: â‰¤60 seconds old)
- `reason` (human-readable intent, e.g., "CAR-T manufacturing - Lot 2025-001")
- `signingAlgorithm` (e.g., `RSA-PSS-SHA256`)
- `certificatePEM` (operator's X.509 certificate, optional for mTLS-authenticated flows)

**Code Example** (TypeScript):
```typescript
const result = await adapter.sendCommand(
  deviceId,
  commandName,
  params,
  {
    operatorId: "OP-2025-001",
    signature: "base64_encoded_signature_here",
    timestamp: new Date().toISOString(),  // Must be â‰¤60 seconds old
    reason: "Start fermentation - Batch FER-2025-12-10-001",
    signingAlgorithm: "RSA-PSS-SHA256",
    certificatePEM: "-----BEGIN CERTIFICATE-----\n..."
  }
);
```

**Validation**:
- âœ… Signature is present and non-empty
- âœ… Timestamp is recent (within 60 seconds, prevents replay attacks)
- âœ… Timestamp format is ISO 8601 (no timezone ambiguity)
- âœ… operatorId matches authenticated user
- âœ… Reason is non-empty and contextual

**Error Handling**:
```typescript
try {
  await adapter.sendCommand(deviceId, cmd, params, null);
} catch (error) {
  // Throws: "Operator signature required for command execution"
}
```

---

### 1.2 E-Signature Capture (Production Implementation)

**Production adapters must implement a user interface or API endpoint for e-signature capture** that:

1. **Intent Capture**: Display the command details to operator
   - Device name, command name, parameters
   - Estimated impact (e.g., "Will start fermentation for 48 hours")
   - Risk level (LOW/MEDIUM/HIGH based on command criticality)

2. **Reason Recording**: Operator provides written intent
   - Free-form text field (min 10 chars, max 500 chars)
   - Examples:
     - "Optimize fermentation yield per protocol FER-2025-Q4-001"
     - "Execute approved DoE run #3 of factorial design"

3. **Signature Capture**: Operator signs with private key
   - PKI-based (X.509 certificates stored in hardware security modules)
   - Biometric optional (fingerprint, facial recognition)
   - Timestamp captured at signature time (server NTP-synchronized)

4. **BPR Linkage**: Signature tied to batch production record
   - Command manifest includes `bprId` (batch identifier)
   - All signatures and manifests exported to BPR PDF for regulatory submission

**Example Workflow**:
```
1. Operator navigates to "Execute Command" UI
2. System displays: "Start fermentation on FERM-001 with 2L volume"
   - Risk: MEDIUM
   - Estimated duration: 48 hours
   - Batch: FER-2025-12-10-001
3. Operator enters reason: "Execute approved protocol per method FER-2025-Q4"
4. System prompts for e-signature (PKI cert + biometric)
5. Signature captured with server timestamp
6. Command queued and manifest generated
7. Manifest included in BPR export
```

---

## 2. Audit & Provenance

### 2.1 Manifest Schema

**Every telemetry payload and command MUST include a manifest** with the following fields:

#### **Telemetry Manifest** (pushed to `/ingest/telemetry` endpoint):
```json
{
  "manifestId": "MF-20251210-ABC123",
  "manifestType": "TELEMETRY",
  "timestamp": "2025-12-10T14:32:15.123Z",
  "deviceId": "FERM-001",
  "streamName": "temperature",
  "adapter_version": "0.1.0",
  "adapter_commit": "abc123def456",
  "container_digest": "sha256:abc123...",
  "dataChecksum": "sha256:abc123def456",
  "complianceFrameworks": ["FDA-21CFR-Part11", "ICH-Q7", "ALCOA+"]
}
```

#### **Command Manifest** (generated by `sendCommand()`):
```json
{
  "manifestId": "MF-20251210-XYZ789",
  "manifestType": "COMMAND",
  "commandId": "cmd-20251210-001",
  "timestamp": "2025-12-10T14:35:22.456Z",
  "deviceId": "FERM-001",
  "commandName": "startFermentation",
  "commandHash": "sha256:abc123def456",
  "operatorId": "OP-2025-001",
  "operatorName": "Dr. Alice Smith",
  "reason": "Execute approved protocol FER-2025-Q4-001",
  "signature": "-----BEGIN SIGNATURE-----\n...",
  "signatureAlgorithm": "RSA-PSS-SHA256",
  "bprId": "BPR-FER-2025-12-10-001",
  "adapter_version": "0.1.0",
  "adapter_commit": "abc123def456",
  "container_digest": "sha256:abc123...",
  "auditTrail": [
    {
      "event": "command_queued",
      "timestamp": "2025-12-10T14:35:20Z",
      "details": {"status": "queued"}
    },
    {
      "event": "operator_signature_captured",
      "timestamp": "2025-12-10T14:35:22Z",
      "details": {"operatorId": "OP-2025-001", "reason": "..."}
    }
  ],
  "complianceFrameworks": ["FDA-21CFR-Part11", "ICH-Q7", "ALCOA+"]
}
```

### 2.2 Provenance Tracking

**All manifests MUST include**:

| Field | Purpose | Example |
|-------|---------|---------|
| `manifestId` | Unique identifier for audit trail | `MF-20251210-ABC123` |
| `timestamp` | ISO 8601, server-verified (NTP) | `2025-12-10T14:32:15.123Z` |
| `deviceId` | Which instrument issued/received command | `FERM-001` |
| `adapter_version` | SDK version (semver) | `0.1.0` |
| `adapter_commit` | Git commit hash (for traceability) | `abc123def456` |
| `container_digest` | Docker image SHA256 (if containerized) | `sha256:abc123...` |
| `dataChecksum` | SHA-256 of payload (tamper detection) | `sha256:abc123def456` |
| `operatorId` | For commands: who authorized action | `OP-2025-001` |
| `auditTrail` | Chronological event log with timestamps | Array of {event, timestamp, details} |
| `complianceFrameworks` | Which regulatory standards apply | `["FDA-21CFR-Part11", "ICH-Q7", "ALCOA+"]` |

### 2.3 Immutable Storage

**Manifests MUST be stored in immutable, long-term retention**:

- **Primary**: PostgreSQL (indexed for fast audit trail queries)
- **Archive**: S3 Glacier (20-year retention per FDA requirement)
- **Encryption**: AES-256 at rest, TLS 1.3 in transit
- **Backup**: Cross-region S3 replication (RTO <1 hour, RPO <15 min)

**Retention Policy**:
```
- Active (0-1 year): PostgreSQL + S3 Standard
- Archive (1-20 years): S3 Glacier Deep Archive
- Post-expiry: Secure deletion with certificate
```

---

## 3. Network & Security

### 3.1 mTLS (Mutual TLS) for Adapter â†” Platform Communication

**Requirement**: All adapter-to-platform communication MUST use mTLS with:

1. **Server Certificate** (Platform side):
   - Issued by trusted CA (DigiCert, Entrust, GlobalSign)
   - Subject: `*.newgen-studio.com`
   - Validity: 1 year, auto-renewal 30 days before expiry
   - Key algorithm: RSA 4096 or ECDSA P-256

2. **Client Certificate** (Adapter side):
   - Issued by NewGen Studio internal CA
   - Subject: `adapter-{organizationId}-{instanceId}`
   - Validity: 90 days (short-lived, auto-renewal)
   - Key algorithm: RSA 4096 or ECDSA P-256
   - Stored in: HSM (Hardware Security Module) or encrypted local vault

3. **Certificate Pinning**:
   - Adapter pins server certificate public key (SHA-256)
   - Prevents man-in-the-middle attacks even if CA is compromised

**Implementation** (Node.js + axios):
```typescript
import https from 'https';
import fs from 'fs';
import axios from 'axios';

const httpsAgent = new https.Agent({
  key: fs.readFileSync('/path/to/client-key.pem'),
  cert: fs.readFileSync('/path/to/client-cert.pem'),
  ca: fs.readFileSync('/path/to/ca-cert.pem'),
  rejectUnauthorized: true,
  secureOptions: https.constants.SSL_OP_NO_TLSv1 | https.constants.SSL_OP_NO_TLSv1_1
});

const client = axios.create({
  httpsAgent,
  baseURL: 'https://api.newgen-studio.com'
});
```

### 3.2 Network Isolation

**Requirement**: Edge gateways and device adapters MUST NOT be exposed to public internet.

**Allowed Network Topologies**:

#### âœ… **Correct: Lab-Network Isolated**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Lab Network       â”‚
â”‚ (10.0.0.0/8, VPN)   â”‚
â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Instrument   â”‚   â”‚
â”‚  â”‚ (OPC-UA)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Edge Gateway â”‚   â”‚â”€â”€â”€â”€â”€ VPN/mTLS â”€â”€â”€â”€â–º NewGen Cloud
â”‚  â”‚ (Adapter)    â”‚   â”‚  (Encrypted tunnel)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### âŒ **Incorrect: Public Exposure**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Instrument     â”‚
â”‚ (Public IP)      â”‚â”€â”€â”€â”€â–º Internet (DANGEROUS!)
â”‚ OPC-UA port 4334 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Controls**:
- ðŸ” Firewall: Block inbound on all ports except VPN
- ðŸ” Network segmentation: Air-gap critical instruments (ICS network)
- ðŸ” VPN gateway: Split tunneling disabled (all traffic routed through VPN)
- ðŸ” Intrusion detection: Monitor for lateral movement
- ðŸ” Logging: All network traffic logged to SIEM (Splunk, ELK)

### 3.3 Credential Management

**API Keys and Certificates MUST be**:
- âœ… Stored in encrypted vault (HashiCorp Vault, AWS Secrets Manager)
- âœ… Rotated every 90 days (automatic)
- âœ… Never logged or printed
- âœ… Restricted by IP/CIDR block (e.g., only 10.0.0.0/8)
- âœ… Revoked immediately if compromised

**Example** (Vault-based credential rotation):
```bash
# Vault server
vault write pki/issue/adapter \
  common_name="adapter-org123-dev" \
  ttl=2160h  # 90 days
```

---

## 4. Validation & Qualification

### 4.1 IQ/OQ/PQ Requirement for Production Use

**When device adapters are used in regulated manufacturing (FDA, EMA, MHRA), they MUST undergo**:

#### **Installation Qualification (IQ)**
- **Objective**: Verify adapter is installed per specifications
- **Activities**:
  - Hardware checklist (network, storage, compute)
  - Software bill of materials (SBOM) verification
  - Certificate installation and validation
  - Security scan (static, dynamic, dependency)
- **Documentation**: IQ report signed by QA
- **Duration**: 1-2 weeks

#### **Operational Qualification (OQ)**
- **Objective**: Verify adapter functions as designed
- **Test Cases**:
  - Device registration (successful, invalid metadata)
  - Telemetry ingestion (valid, out-of-range, missing fields)
  - Command execution (with signature, without signature)
  - Manifest generation (integrity, completeness)
  - Error recovery (network timeout, invalid device)
  - Compliance reporting (BPR export, audit trail)
- **Success Criteria**: 100% pass rate, <5% defects
- **Duration**: 2-4 weeks

#### **Performance Qualification (PQ)**
- **Objective**: Verify adapter meets business requirements in production
- **Test Cases**:
  - Telemetry latency (<1 second, 95th percentile)
  - Command execution time (<5 seconds)
  - Data integrity (zero missing records, zero corrupted data)
  - Availability (99.5% uptime over 30 days)
  - Scalability (1000 telemetry events/minute)
- **Success Criteria**: All metrics met for 30 days
- **Duration**: 4-8 weeks

**Deliverables**:
- IQ Report (signed)
- OQ Test Protocol + Results (signed)
- PQ Test Protocol + Results (signed)
- Risk Assessment + Mitigation (FMEA)
- Change Control Process (SOP)

---

### 4.2 Simulator NOT for Production Validation

**âŒ PROHIBITED**: Using simulator data, configurations, or artifacts in:
- Production validation datasets
- Regulatory submissions (IND, BLA)
- Historical batch records
- Statistical process control models
- Predictive analytics training

**âœ… ALLOWED**: Using simulator for:
- Local development and unit testing
- CI/CD smoke tests
- Documentation and training examples
- Proof-of-concept demonstrations

**Why**: Simulator uses stochastic kinetics with artificial noise. Real devices have systematic biases, equipment-specific calibrations, and historical variation that must be captured in real data.

---

## 5. Implementation Checklist

### 5.1 Pre-Deployment Checklist

- [ ] **Code Review**
  - [ ] No hardcoded credentials (API keys, passwords)
  - [ ] No telemetry of PII or proprietary data
  - [ ] All external inputs validated and sanitized
  - [ ] Error messages do not leak system details

- [ ] **Dependency Audit**
  - [ ] `npm audit` passes (zero critical vulnerabilities)
  - [ ] All dependencies pinned to exact versions (no `^` or `~`)
  - [ ] SBOM (software bill of materials) generated
  - [ ] License compliance checked (no GPL unless approved)

- [ ] **Security Testing**
  - [ ] Static analysis (ESLint, TypeScript strict mode)
  - [ ] Dependency scanning (Snyk, WhiteSource)
  - [ ] SAST (Sonarqube or similar)
  - [ ] Penetration testing (external security firm)

- [ ] **Compliance Verification**
  - [ ] Manifests include all required fields
  - [ ] Operator signature validation working
  - [ ] Audit trails immutable (write-once storage)
  - [ ] 20-year retention policy configured
  - [ ] mTLS certificates installed and validated

- [ ] **Documentation**
  - [ ] Security architecture documented (threat model, controls)
  - [ ] Operating procedures (deployment, backup, recovery)
  - [ ] Troubleshooting guide (common issues, escalation)
  - [ ] Training materials for operators and admins

---

### 5.2 Post-Deployment Checklist

- [ ] **Monitoring & Alerting**
  - [ ] Metrics collected (telemetry latency, command execution time)
  - [ ] Logs aggregated to SIEM (Splunk, ELK, Datadog)
  - [ ] Alerts configured (disk full, cert expiry, failed commands)
  - [ ] On-call runbook in place

- [ ] **Backup & Recovery**
  - [ ] Backups automated (daily, tested monthly)
  - [ ] Recovery time objective (RTO) validated (<1 hour)
  - [ ] Recovery point objective (RPO) validated (<15 min)
  - [ ] Encryption keys backed up separately

- [ ] **Compliance Audit**
  - [ ] Audit trail reviewed (no missing records)
  - [ ] All commands have operator signatures
  - [ ] Manifests match regulatory requirements
  - [ ] No cross-tenant data leakage

- [ ] **Operational Excellence**
  - [ ] Change log maintained (all config changes)
  - [ ] User access reviewed (least privilege)
  - [ ] Incident response plan tested
  - [ ] Annual security training completed

---

## 6. Compliance Frameworks

### 6.1 FDA 21 CFR Part 11 (US)

**Requirement**: Electronic Records and Electronic Signatures

| Requirement | Implementation |
|-------------|-----------------|
| **21.100 - Scope** | Applies to all electronic records and signatures used for regulated data |
| **21.101 - Applicability** | Manifests and BPRs are electronic records; operator signatures are e-signatures |
| **21.103 - Definitions** | Audit trail = immutable log; E-signature = operator PKI-based digital signature |
| **21.108 - General requirements** | System must maintain data integrity, accuracy, authenticity, readability |
| **21.110 - Use of systems** | Only validated systems allowed in production |
| **21.200 - Electronic signatures** | Must be unique, non-repudiable, timestamp-validated |

---

### 6.2 Health Canada GMP (Canada)

**Requirement**: Good Manufacturing Practice guidelines

| Requirement | Implementation |
|-------------|-----------------|
| **Electronic data** | Must maintain data integrity throughout product lifecycle |
| **System validation** | IQ/OQ/PQ required before production use |
| **Audit trails** | All changes logged with user ID, timestamp, reason |
| **E-signatures** | Digital signatures must be secure, traceable, unambiguous |

---

### 6.3 ICH Q7 (International)

**Requirement**: API Manufacturing Quality

| Requirement | Implementation |
|-------------|-----------------|
| **Data integrity** | ALCOA+ principles (Attributable, Legible, Contemporaneous, Original, Accurate, Complete, Consistent, Enduring, Available) |
| **System suitability** | Adapter must demonstrate fit-for-purpose in equipment qualification |
| **Change management** | All changes documented with impact assessment and approval |

---

### 6.4 ALCOA+ (Data Integrity Standard)

| Attribute | Implementation |
|-----------|-----------------|
| **Attributable** | Every record tied to operator via e-signature; audit trail identifies who, when, why |
| **Legible** | All data human-readable; exports available in PDF, JSON, XML |
| **Contemporaneous** | Timestamps captured at data generation (server-synchronized NTP) |
| **Original** | Data immutable once recorded; changes create new records with audit trail |
| **Accurate** | Input validation (Joi schemas); data checksums; anomaly detection |
| **Complete** | No gaps in telemetry; all commands logged; manifests contain all required fields |
| **Consistent** | Same data format across all batches; templates ensure consistency |
| **Enduring** | 20-year archival in S3 Glacier; encrypted, redundant storage |
| **Available** | Query APIs for audit trail retrieval; BPR export on-demand |

---

## 7. Appendices

### 7.1 Appendix A: Manifest Generation Code

**Example: Generating a command manifest** (TypeScript):
```typescript
import crypto from 'crypto';

function generateCommandManifest(
  deviceId: string,
  commandName: string,
  operatorId: string,
  operatorSignature: string,
  commandParams: Record<string, any>
): CommandManifest {
  const timestamp = new Date().toISOString();
  const commandHash = crypto
    .createHash('sha256')
    .update(JSON.stringify({ deviceId, commandName, commandParams }))
    .digest('hex');
  
  return {
    manifestId: `MF-${timestamp.split('T')[0]}-${Math.random().toString(36).slice(2, 8).toUpperCase()}`,
    manifestType: 'COMMAND',
    timestamp,
    deviceId,
    commandName,
    commandHash,
    operatorId,
    signature: operatorSignature,
    signatureAlgorithm: 'RSA-PSS-SHA256',
    auditTrail: [
      {
        event: 'command_issued',
        timestamp,
        details: { operatorId, commandName }
      }
    ],
    complianceFrameworks: ['FDA-21CFR-Part11', 'ICH-Q7', 'ALCOA+']
  };
}
```

---

### 7.2 Appendix B: mTLS Certificate Setup (OpenSSL)

**Generate adapter client certificate**:
```bash
# 1. Create private key
openssl genrsa -out adapter-key.pem 4096

# 2. Create certificate signing request (CSR)
openssl req -new \
  -key adapter-key.pem \
  -out adapter.csr \
  -subj "/CN=adapter-org123-prod/O=Organization/C=US"

# 3. Sign CSR with NewGen internal CA (90-day validity)
openssl x509 -req \
  -in adapter.csr \
  -CA ca-cert.pem \
  -CAkey ca-key.pem \
  -CAcreateserial \
  -out adapter-cert.pem \
  -days 90 \
  -sha256

# 4. Verify certificate
openssl x509 -in adapter-cert.pem -text -noout
```

---

### 7.3 Appendix C: Audit Trail Query Examples

**Query all commands executed by operator**:
```sql
SELECT 
  manifestId,
  commandId,
  timestamp,
  commandName,
  operatorId,
  reason,
  status
FROM manifests
WHERE 
  manifestType = 'COMMAND'
  AND operatorId = 'OP-2025-001'
  AND timestamp >= NOW() - INTERVAL '90 days'
ORDER BY timestamp DESC;
```

**Query telemetry ingestion for device**:
```sql
SELECT 
  manifestId,
  timestamp,
  streamName,
  dataChecksum
FROM manifests
WHERE 
  manifestType = 'TELEMETRY'
  AND deviceId = 'FERM-001'
  AND timestamp >= NOW() - INTERVAL '30 days'
ORDER BY timestamp ASC;
```

---

### 7.4 Appendix D: Security Incident Response

**In case of security incident** (breach, compromise, unauthorized access):

1. **Immediate** (0-1 hour):
   - [ ] Isolate affected adapter (network disconnect)
   - [ ] Preserve logs (copy to secure location)
   - [ ] Notify security team and QA

2. **Short-term** (1-24 hours):
   - [ ] Conduct forensic analysis (audit trail review)
   - [ ] Revoke compromised certificates
   - [ ] Reset all API keys
   - [ ] Notify affected customers

3. **Medium-term** (1-7 days):
   - [ ] Root cause analysis (FMEA)
   - [ ] Implement corrective actions
   - [ ] Updated security procedures
   - [ ] Regulatory reporting (if required)

4. **Long-term** (ongoing):
   - [ ] Preventive measures deployed
   - [ ] Monitoring enhanced
   - [ ] Training updated
   - [ ] Incident report filed

---

## Approval & Sign-Off

| Role | Name | Signature | Date |
|------|------|-----------|------|
| **Technical Lead** | [Name] | \_\_\_\_\_\_\_\_ | [Date] |
| **Security Officer** | [Name] | \_\_\_\_\_\_\_\_ | [Date] |
| **Regulatory Affairs** | [Name] | \_\_\_\_\_\_\_\_ | [Date] |
| **QA Manager** | [Name] | \_\_\_\_\_\_\_\_ | [Date] |

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-10 | Technical Leadership | Initial release |

---

**END OF DOCUMENT**

---

**Document Classification**: Technical Standard  
**Distribution**: Internal technical teams, QA, regulatory affairs  
**Next Review**: 2026-06-10 (annual review or upon regulatory change)
